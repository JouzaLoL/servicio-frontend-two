<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Servicio Frontend API Example</title>

    <script src="./helper.js"></script>
    <!-- W3.CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- JQuery Modal -->
    <script src="jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="jquery.modal.css" type="text/css" media="screen" />
    <!-- JS Cookie -->
    <script src="js.cookie.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>
    <script>
        var baseUrl = "https://servicio-api.herokuapp.com/api";
        function refresh() {
            let token;
            if (window.token) {
                token = window.token;
            } else if (Cookies.get('servicio-apitoken_vendor')) {
                token = Cookies.get('servicio-apitoken_vendor');
            } else {
                return false;
            }

            // Update Services list
            let $servicestable = $('table#services');
            let $servicestrs = $('tr.service');
            $servicestrs.remove();

            $.ajax({
                url: baseUrl + "/vendor/services",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                data.services.forEach(function (service) {
                    let $tr = c('tr', { class: "service" });
                    $tr.append(c('td', { class: "car_model w3-large w3-margin-bottom" }).text(service.car.model));
                    $tr.append(c('td', { class: "car_spz w3-margin-right w3-monospace w3-large w3-border w3-padding-small w3-border-black" }).text(service.car.SPZ));
                    $tr.append(c('td', { class: "car_vin w3-margin-right w3-monospace w3-border w3-padding-small w3-border-black" }).text(service.car.VIN));
                    $tr.append(c('td', { class: "service_date" }).text("Datum: " + new Date(service.date).toLocaleDateString()));
                    $tr.append(c('td', { class: "service_vendor" }).text("Servis: " + service.vendor));
                    $tr.append(c('td', { class: "service_mechanic" }).text("Mechanik: " + service.mechanicName));
                    $tr.append(c('td', { class: "service_cost" }).text("Cena: " + service.cost + " Kč"));
                    $tr.append(c('td', { class: "service_description" }).text("Popis: " + service.description));
                    $tr.append(c('td').append(c('a', { class: 'service_receipt w3-right', href: "#" }).text('Účtenka')));
                    $tr.append(c('img', { src: "data:" + service.receipt.contentType + ";base64," + bufferToBase64(new Uint8Array(service.receipt.data.data)), style: "display:none" }));
                    $tr.appendTo($servicestable);
                });

                registerEvents();
            });

            // Update Profile
            $.ajax({
                url: baseUrl + "/vendor/",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                $('span#name').text(data.vendor.name);
                window._id = data.vendor._id;
            });
        }

        function registerEvents() {
            $('a.service_receipt').click((eventObject) => {
                eventObject.preventDefault();
                let img = $(eventObject.target).parent().parent().find('img').clone();
                $(img).modal();
            });
        }


        // Main entry point
        $(document).ready(() => {
            // Login or restore session from cookie
            if (!Cookies.get('servicio-apitoken_vendor')) {
                $('div#login').modal({
                    escapeClose: false,
                    clickClose: false,
                    showClose: false
                });
            } else {
                window.token = Cookies.get('servicio-apitoken_vendor');
                refresh();
            }

            $('a#register').click((e) => {
                e.preventDefault();
                $('div#register').modal({ closeExisting: false });
            });

            $('input#register').click(
                () => {
                    let data = parseForm('form#register');
                    $.ajax({
                        url: baseUrl + "/vendor/register",
                        method: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: data
                    }).done((data) => {
                        if (data.success) {
                            $(c('div', { class: "success" }).text("Registrace úspěšná")).modal({
                                closeExisting: false
                            }).on($.modal.AFTER_CLOSE, function (event, modal) {
                                $.modal.close();
                            });
                        }
                    }).fail((data) => {
                        if (data.responseJSON.statusText == "Validation Error") {
                            $(c('div', { class: "error" }).text("Email se již používá")).modal({
                                closeExisting: false
                            });
                        }
                    });
                }
            );

            $('input#login').click(() => {

                let data = parseForm('form#login');
                $.ajax({
                    url: baseUrl + "/vendor/authenticate",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data
                }).done((data) => {
                    if (!data.success) { return; }

                    $(c('div', { class: "success" }).text("Přihlášení úspěšné")).modal();

                    window.token = data.token;
                    Cookies.set('servicio-apitoken_vendor', data.token);
                    refresh();

                }).fail((d) => {
                    let data = d.responseJSON;
                    if (data.error == "BadPassword") {
                        $(c('div', { class: "error" }).text("Špatné heslo")).modal({
                            closeExisting: false
                        });
                    } else if (data.error == "UserNotFound") {
                        $(c('div', { class: "error" }).text("Uživatel neexistuje")).modal({
                            closeExisting: false
                        });
                    }
                });
            });

            $('a#logout').click(() => {
                $('div#login').modal();
                Cookies.remove('servicio-apitoken_vendor');
            });

            $('button#addService').click(() => {
                $('div#addService').modal();
            });

            $('input#addService').click(() => {
                let d = parseForm('form#addService');

                var reader = new FileReader();
                reader.readAsDataURL($('#file')[0].files[0]);
                reader.onload = () => {
                    let receipt = {
                        data: reader.result.split(',')[1],
                        contentType: $('#file')[0].files[0].type
                    };
                    let data = JSON.parse(d);
                    data.receipt = receipt;
                    data.vendorID = window._id;
                    data.date = new Date(data.date).toISOString()
                    $.ajax({
                        url: baseUrl + "/vendor/cars/search/" + data.SPZ,
                        method: "GET",
                        contentType: "application/json; charset=utf-8",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-Access-Token', window.token);
                        },
                        dataType: "json",
                    }).done((car) => {

                        $.ajax({
                            url: baseUrl + "/vendor/cars/" + car.car._id + "/services",
                            method: "POST",
                            contentType: "application/json; charset=utf-8",
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('X-Access-Token', window.token);
                            },
                            dataType: "json",
                            data: JSON.stringify(data)
                        }).done((res) => {
                            if (res.success) {
                                refresh();
                                $.modal.close();
                            }
                        });
                    });
                };
            });
        });
    </script>

    <!-- MAIN -->

    <div>
        <div id="navigation" class="w3-bar w3-blue-grey">
            <div id="menu">
                <span class="w3-bar-item w3-large">Servicio</span>
            </div>
            <div id="account" class="w3-right">
                <span class="w3-bar-item" id="name"></span>
                <a href="" id="profile" class="w3-bar-item">Profil</a>
                <a href="" id="logout" class="w3-bar-item">Odhlásit se</a>
            </div>
        </div>
        <div id="body">
            <div id="services" class="w3-container">
                <h2>Záznamy</h2>
                <table class="w3-table w3-striped w3-bordered" id="services">
                </table>
            </div>
            <button id="addService" class="w3-button w3-blue-grey w3-margin">Přidat záznam</button>
        </div>
    </div>

    <!-- MODALS-->

    <div id="login" style="display:none">
        <h3>Přihlášení</h3>
        <form id="login">
            <label for="email">Email: </label><input type="text" name="email" class="w3-input"> <br>
            <label for="password">Heslo: </label><input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Login" id="login" class="w3-input">
        </form>
        <span><a href="" id="register">Nemáte účet? Registrujte se</a></span>
    </div>

    <div id="register" style="display:none">
        <h3>Registrace</h3>
        <form id="register">
            <label for="name">Jméno: </label><input type="text" name="name" class="w3-input"> <br>
            <label for="email">Email: </label><input type="text" name="email" class="w3-input"> <br>
            <label for="password">Heslo: </label><input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Register" id="register" class="w3-input">
        </form>
    </div>

    <div id="addService" style="display:none">
        <h3>Přidat záznam</h3>
        <form id="addService">
            <label for="SPZ">SPZ auta</label><input type="text" name="SPZ" class="w3-input"> <br>
            <label for="mechanicName">Jméno mechanika</label><input type="text" name="mechanicName" class="w3-input"> <br>
            <label for="date">Datum: </label><input type="date" name="date" class="w3-input" id="date"> <br>
            <label for="cost">Cena: </label><input type="number" name="cost" class="w3-input"> <br>
            <label for="description">Popis: </label><input type="text" name="description" class="w3-input"><br>
            <label for="file">Účtenka: </label><input type="file" accept="image/*" id="file" multiple="false" name="receipt"
                class="w3-input"><br>
            <input type="button" value="Add" id="addService" class="w3-input">
        </form>
    </div>

</body>

</html>