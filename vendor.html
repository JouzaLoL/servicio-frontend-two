<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Servicio Frontend API Example</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <script src="./helper.js"></script>
    <!-- W3.CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- JQuery Modal -->
    <script src="jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="jquery.modal.css" type="text/css" media="screen" />
    <!-- JS Cookie -->
    <script src="js.cookie.js"></script>
</head>

<body>
    <script>
        var baseUrl = "https://servicio-api.herokuapp.com/api";
        function refresh() {
            let token;
            if (window.token) {
                token = window.token;
            } else if (Cookies.get('servicio-apitoken_vendor')) {
                token = Cookies.get('servicio-apitoken_vendor');
            } else {
                return false;
            }

            // Update Services list
            let $servicestable = $('table#services');
            let $servicestrs = $('tr.service');
            $servicestrs.remove();

            $.ajax({
                url: baseUrl + "/vendor/services",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                data.services.forEach(function (service) {
                    let $tr = c('tr', { class: "service" });
                    $tr.append(c('td', { class: "car_model w3-large w3-margin-bottom" }).text(service.car.model));
                    $tr.append(c('td', { class: "car_spz w3-margin-right w3-monospace w3-large w3-border w3-padding-small w3-border-black" }).text(service.car.SPZ));
                    $tr.append(c('td', { class: "service_cost" }).text("Cost: " + service.cost + " KÄ"));
                    $tr.append(c('td', { class: "service_description" }).text("Description: " + service.description));
                    $tr.appendTo($servicestable);
                });

                registerEvents();
            });

            // Update Profile
            $.ajax({
                url: baseUrl + "/vendor/",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                $('span#name').text(data.vendor.name);
                window._id = data.vendor._id;
            });
        }

        function registerEvents() {
            // $('a.car_remove').click((eventObject) => {
            //     eventObject.preventDefault();
            //     $(eventObject.target).text('Confirm').addClass('confirm_deletion');

            //     $('a.confirm_deletion').click((eventObject) => {
            //         eventObject.preventDefault();
            //         let id = $(eventObject.target).parent().parent().find('.car_id').text();
            //         $.ajax({
            //             url: baseUrl + "/user/cars/" + id,
            //             method: "DELETE",
            //             beforeSend: function (xhr) {
            //                 xhr.setRequestHeader('X-Access-Token', token);
            //             },
            //             contentType: "application/json; charset=utf-8",
            //             dataType: "json"
            //         }).done(() => {
            //             refresh();
            //         });
            //     });
            // });

            $('a.service_image').click((eventObject) => {
                eventObject.preventDefault();

                $('div#editCar').modal();
                $('input#editCar').click(() => {

                    let d = JSON.parse(parseForm('form#editCar'));
                    Object.keys(d).forEach((key) => {
                        if (d[key] == "") {
                            d[key] = undefined;
                        }
                    });
                    let data = JSON.stringify(d);
                    let id = $(eventObject.target).parent().parent().find('.car_id').text();

                    $.ajax({
                        url: baseUrl + "/user/cars/" + id,
                        method: "PATCH",
                        contentType: "application/json; charset=utf-8",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-Access-Token', token);
                        },
                        dataType: "json",
                        data: data
                    }).done((data) => {
                        if (!data.success) { return; }

                        $(c('div', { class: "success" }).text("Edit succesful")).modal();
                        refresh();
                    });
                });
            });

            $('a.car_entries').click((eventObject) => {
                eventObject.preventDefault();
                let id = $(eventObject.target).parent().parent().find('.car_id').text();
                $.ajax({
                    url: baseUrl + "/user/cars/" + id + "/services",
                    method: "GET",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-Access-Token', token);
                    },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                }).done((data) => {
                    data.serviceBook.forEach(function (car) {
                        let $li = c('li', { class: "car" });
                        $li.append(c('span', { class: "car_model w3-large w3-margin-bottom" }).text(car.model));
                        $li.append(c('br'));
                        $li.append(c('span', { class: "car_spz w3-margin-right w3-monospace w3-large w3-border w3-padding-small w3-border-black" }).text(car.SPZ));
                        $li.append(c('span', { class: "car_year" }).text("Year: " + car.year));
                        $li.append(c('span').append(c('a', { class: 'car_remove w3-button  w3-right', href: "#" }).text('Remove')));
                        $li.append(c('span').append(c('a', { class: 'car_edit w3-button  w3-right', href: "#" }).text('Edit')));
                        $li.append(c('span').append(c('a', { class: 'car_entries w3-button  w3-right', href: "#" }).text('Service Entries')));
                        $li.append(c('span', { class: "car_id", style: "display:none" }).text(car._id));
                        $li.appendTo($carlist);
                    });
                });
            });
        }


        // Main entry point
        $(document).ready(() => {
            if (!Cookies.get('servicio-apitoken_vendor')) {
                $('div#login').modal({
                    escapeClose: false,
                    clickClose: false,
                    showClose: false
                });
            } else {
                window.token = Cookies.get('servicio-apitoken_vendor');
                refresh();
            }

            $('a#register').click((e) => {
                e.preventDefault();
                $('div#register').modal({ closeExisting: false });
            });

            $('input#register').click(
                () => {
                    let data = parseForm('form#register');
                    $.ajax({
                        url: baseUrl + "/vendor/register",
                        method: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: data
                    }).done((data) => {
                        if (data.success) {
                            $(c('div', { class: "success" }).text("Registered succesfully")).modal({
                                closeExisting: false
                            }).on($.modal.AFTER_CLOSE, function (event, modal) {
                                $.modal.close();
                            });
                        }
                    }).fail((data) => {
                        if (data.responseJSON.statusText == "Validation Error") {
                            $(c('div', { class: "error" }).text("Email already exists")).modal({
                                closeExisting: false
                            });
                        }
                    });
                }
            );

            $('input#login').click(() => {

                let data = parseForm('form#login');
                $.ajax({
                    url: baseUrl + "/vendor/authenticate",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data
                }).done((data) => {
                    if (!data.success) { return; }

                    $(c('div', { class: "success" }).text("Login successful")).modal();

                    window.token = data.token;
                    Cookies.set('servicio-apitoken_vendor', data.token);
                    refresh();

                }).fail((d) => {
                    let data = d.responseJSON;
                    if (data.error == "BadPassword") {
                        $(c('div', { class: "error" }).text("Wrong password")).modal({
                            closeExisting: false
                        });
                    } else if (data.error == "UserNotFound") {
                        $(c('div', { class: "error" }).text("User doesn't exist")).modal({
                            closeExisting: false
                        });
                    }
                });
            });

            $('a#logout').click(() => {
                $('div#login').modal();
                Cookies.remove('servicio-apitoken_vendor');
            });

            $('button#addService').click(() => {
                $('div#addService').modal();
            });

            $('input#addService').click(() => {
                let d = parseForm('form#addService');

                var reader = new FileReader();
                reader.readAsDataURL($('#file')[0].files[0]);
                reader.onload = () => {
                    let receipt = {
                        data: reader.result.split(',')[1],
                        contentType: $('#file')[0].files[0].type
                    };
                    let data = JSON.parse(d);
                    data.receipt = receipt;
                    data.vendorID = window._id;
                    data.date = new Date(data.date).toISOString()
                    $.ajax({
                        url: baseUrl + "/vendor/cars/search/" + data.SPZ,
                        method: "GET",
                        contentType: "application/json; charset=utf-8",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-Access-Token', window.token);
                        },
                        dataType: "json",
                    }).done((car) => {

                        $.ajax({
                            url: baseUrl + "/vendor/cars/" + car.car._id + "/services",
                            method: "POST",
                            contentType: "application/json; charset=utf-8",
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('X-Access-Token', window.token);
                            },
                            dataType: "json",
                            data: JSON.stringify(data)
                        }).done((res) => {
                            if(res.success) {
                                refresh();
                                $.modal.close();
                            }
                        });
                    });
                };
            });
        });
    </script>

    <!-- MAIN -->

    <div>
        <div id="navigation" class="w3-bar w3-blue-grey w3-padding">
            <div id="menu">
                <span class="w3-bar-item w3-large">Servicio</span>
            </div>
            <div id="account" class="w3-right">
                <span class="w3-bar-item" id="name"></span>
                <a href="" id="profile" class="w3-bar-item">Profile</a>
                <a href="" id="logout" class="w3-bar-item">Log out</a>
            </div>
        </div>
        <div id="body">
            <div id="services" class="w3-container">
                <h2>Services</h2>
                <table class="w3-table w3-striped w3-bordered" id="services">
                </table>
            </div>
            <button id="addService" class="w3-button w3-blue-grey w3-margin">Add Service</button>
        </div>
    </div>

    <!-- MODALS-->

    <div id="login" style="display:none">
        <h3>Login</h3>
        <form id="login">
            <label for="email">Email: </label><input type="text" name="email" class="w3-input"> <br>
            <label for="password">Password: </label><input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Login" id="login" class="w3-input">
        </form>
        <span><a href="" id="register">Don't have an account? Register</a></span>
    </div>

    <div id="register" style="display:none">
        <h3>Register</h3>
        <form id="register">
            <label for="name">Name: </label><input type="text" name="name" class="w3-input"> <br>
            <label for="email">Email: </label><input type="text" name="email" class="w3-input"> <br>
            <label for="password">Password: </label><input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Register" id="register" class="w3-input">
        </form>
    </div>

    <div id="addService" style="display:none">
        <h3>Add Service</h3>
        <form id="addService">
            <label for="SPZ">SPZ</label><input type="text" name="SPZ" class="w3-input"> <br>
            <label for="date">Date: </label><input type="date" name="date" class="w3-input" id="date"> <br>
            <label for="cost">Cost: </label><input type="number" name="cost" class="w3-input"> <br>
            <label for="description">Description: </label><input type="text" name="description" class="w3-input"><br>
            <label for="description">Receipt: </label><input type="file" accept="image/*" id="file" multiple="false" name="receipt"
                class="w3-input"><br>
            <input type="button" value="Add" id="addService" class="w3-input">
        </form>
    </div>

    <div id="editCar" style="display:none">
        <h3>Edit Car</h3>
        <form id="editCar">
            <label for="SPZ">SPZ: </label><input type="text" name="SPZ" class="w3-input"> <br>
            <label for="model">Model: </label><input type="text" name="model" class="w3-input"> <br>
            <label for="year">year: </label><input type="text" name="year" class="w3-input"> <br>
            <input type="button" value="Edit" id="editCar" class="w3-input">
        </form>
    </div>

</body>

</html>