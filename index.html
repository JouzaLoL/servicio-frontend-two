<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Servicio Frontend API Example</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <script src="./helper.js"></script>
    <!-- W3.CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- JQuery Modal -->
    <script src="jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="jquery.modal.css" type="text/css" media="screen" />
    <!-- JS Cookie -->
    <script src="js.cookie.js"></script>
</head>

<body>
    <script>
        var baseUrl = "https://servicio-api.herokuapp.com/api";
        function refresh() {
            let token;
            if (window.token) {
                token = window.token;
            } else if (Cookies.get('servicio-apitoken')) {
                token = Cookies.get('servicio-apitoken');
            } else {
                return false;
            }


            // Update Cars table
            let $cartable = $('table#cars');
            let $cartrs = $('tr.car');
            $cartrs.remove();

            $.ajax({
                url: baseUrl + "/user/cars",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                data.cars.forEach(function (car) {
                    let $tr = c('tr', { class: "car" });
                    $tr.append(c('td', { class: "car_model w3-large w3-margin-bottom" }).text(car.model));
                    $tr.append(c('br'));
                    $tr.append(c('td', { class: "car_spz w3-margin-right w3-monospace w3-large w3-border w3-padding-small w3-border-black" }).text(car.SPZ));
                    $tr.append(c('td', { class: "car_vin w3-margin-right w3-monospace w3-border w3-padding-small w3-border-black" }).text(car.VIN));
                    $tr.append(c('td', { class: "car_year" }).text("Rok: " + car.year));
                    $tr.append(c('td').append(c('a', { class: 'car_entries  w3-padding', href: "#" }).text('Záznamy')));
                    $tr.append(c('td', { class: "car_id", style: "display:none" }).text(car._id));
                    $tr.appendTo($cartable);
                });

                registerEvents();
            });

            // Update Profile
            $.ajax({
                url: baseUrl + "/user/",
                method: "GET",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-Access-Token', token);
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            }).done((data) => {
                $('span#name').text(data.user.name);
            });
        }

        function registerEvents() {
            // Remove Car
            $('a.car_remove').click((eventObject) => {
                eventObject.preventDefault();
                $(eventObject.target).text('Potvrdit').addClass('confirm_deletion');

                $('a.confirm_deletion').click((eventObject) => {
                    eventObject.preventDefault();
                    let id = $(eventObject.target).parent().parent().find('.car_id').text();
                    $.ajax({
                        url: baseUrl + "/user/cars/" + id,
                        method: "DELETE",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-Access-Token', token);
                        },
                        contentType: "application/json; charset=utf-8",
                        dataType: "json"
                    }).done(() => {
                        refresh();
                    });
                });
            });

            // Edit Car
            $('a.car_edit').click((eventObject) => {
                eventObject.preventDefault();

                $('div#editCar').modal();
                $('input#editCar').click(() => {

                    let d = JSON.parse(parseForm('form#editCar'));
                    Object.keys(d).forEach((key) => {
                        if (d[key] == "") {
                            d[key] = undefined;
                        }
                    });
                    let data = JSON.stringify(d);
                    let id = $(eventObject.target).parent().parent().find('.car_id').text();

                    $.ajax({
                        url: baseUrl + "/user/cars/" + id,
                        method: "PATCH",
                        contentType: "application/json; charset=utf-8",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-Access-Token', token);
                        },
                        dataType: "json",
                        data: data
                    }).done((data) => {
                        if (!data.success) { return; }

                        $(c('div', { class: "success" }).text("Edit succesful")).modal();
                        refresh();
                    });
                });
            });

            // Display Car's Service Entries
            $('a.car_entries').click((eventObject) => {
                eventObject.preventDefault();
                let id = $(eventObject.target).parent().parent().find('.car_id').text();
                $.ajax({
                    url: baseUrl + "/user/cars/" + id + "/services",
                    method: "GET",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-Access-Token', token);
                    },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                }).done((data) => {
                    var $table = c('table', { id: "serviceModal", class: "w3-table w3-striped w3-bordered" });
                    var $modal = c('div');
                    data.serviceBook.forEach(function (service) {
                        let $tr = c('tr', { class: "service" });
                        $tr.append(c('td', { class: "service_vendor" }).text("Servis: " + service.vendor));
                        $tr.append(c('td', { class: "service_mechanic" }).text("Mechanik: " + service.mechanicName));
                        $tr.append(c('td', { class: "service_date" }).text("Datum: " + new Date(service.date).toLocaleDateString()));
                        $tr.append(c('td', { class: "service_cost" }).text("Cena: " + service.cost + " Kč"));
                        $tr.append(c('td', { class: "service_description" }).text("Popis: " + service.description));
                        $tr.append(c('td').append(c('a', { class: 'service_receipt w3-right', href: "#" }).text('Účtenka')));
                        $tr.append(c('img', { src: "data:" + service.receipt.contentType + ";base64," + bufferToBase64(new Uint8Array(service.receipt.data.data)), style: "display:none" }));
                        $tr.appendTo($table);
                    });
                    $table.appendTo($modal);
                    $modal.modal();

                    // Display Service's Receipt
                    $('a.service_receipt').click((eventObject) => {
                        eventObject.preventDefault();
                        let img = $(eventObject.target).parent().parent().find('img').clone();
                        $(img).modal({ closeExisting: false });
                    });

                });
            });
        }

        $(document).ready(() => {
            // Login or restore session from cookie
            if (!Cookies.get('servicio-apitoken')) {
                $('div#login').modal({
                    escapeClose: false,
                    clickClose: false,
                    showClose: false
                });
            } else {
                window.token = Cookies.get('servicio-apitoken');
                refresh();
            }

            // Show register modal
            $('a#register').click((e) => {
                e.preventDefault();
                $('div#register').modal({ closeExisting: false });
            });

            $('input#register').click(
                () => {
                    let data = parseForm('form#register');
                    $.ajax({
                        url: baseUrl + "/user/register",
                        method: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: data
                    }).done((data) => {
                        if (data.success) {
                            $(c('div', { class: "success" }).text("Registrace úspěšná")).modal({
                                closeExisting: false
                            }).on($.modal.AFTER_CLOSE, function (event, modal) {
                                $.modal.close();
                            });
                        }
                    }).fail((data) => {
                        if (data.responseJSON.statusText == "Validation Error") {
                            $(c('div', { class: "error" }).text("Email se již používá")).modal({
                                closeExisting: false
                            });
                        }
                    });
                }
            );

            $('input#login').click(() => {

                let data = parseForm('form#login');
                $.ajax({
                    url: baseUrl + "/user/authenticate",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data
                }).done((data) => {
                    if (!data.success) { return; }

                    $(c('div', { class: "success" }).text("Přihlášení úspěšné")).modal();

                    window.token = data.token;
                    Cookies.set('servicio-apitoken', data.token);
                    refresh();

                }).fail((d) => {
                    let data = d.responseJSON;
                    if (data.error == "BadPassword") {
                        $(c('div', { class: "error" }).text("Špatné heslo")).modal({
                            closeExisting: false
                        });
                    } else if (data.error == "UserNotFound") {
                        $(c('div', { class: "error" }).text("Uživatel neexistuje")).modal({
                            closeExisting: false
                        });
                    }
                });
            });

            $('a#logout').click(() => {
                $('div#login').modal();
                Cookies.remove('servicio-apitoken');
            });

            $('button#addCar').click(() => {
                $('div#addCar').modal();
            });

            $('input#addCar').click(() => {
                let data = parseForm('form#addCar');
                $.ajax({
                    url: baseUrl + "/user/cars",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-Access-Token', window.token);
                    },
                    dataType: "json",
                    data: data
                }).done((data) => {
                    if (!data.success) { return; }

                    $(c('div', { class: "success" }).text("Auto přidáno")).modal();
                    refresh();

                });
            });
        });
    </script>

    <!-- MAIN -->

    <div>
        <div id="navigation" class="w3-bar w3-blue-grey">
            <div id="menu">
                <span href="#nspanvigation" class="w3-bar-item w3-large">Servicio</span>
            </div>
            <div id="account" class="w3-right">
                <span class="w3-bar-item" id="name"></span>
                <a href="" id="profile" class="w3-bar-item">Profil</a>
                <a href="" id="logout" class="w3-bar-item">Odhlásit se</a>
            </div>
        </div>
        <div id="body">
            <div id="cars" class="w3-container">
                <h2>Cars</h2>
                <table class="w3-table w3-card-4" id="cars">
                </table>
            </div>
            <button id="addCar" class="w3-button w3-blue-grey w3-margin">Přidat auto</button>
        </div>
    </div>

    <!-- MODALS-->

    <div id="login" style="display:none">
        <h3>Přihlášení</h3>
        <form id="login">
            <label for="email">Email: </label><input type="text" name="email" class="w3-input"> <br>
            <label for="password">Heslo: </label><input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Login" id="login" class="w3-input">
        </form>
        <span><a href="" id="register">Nemáte účet? Registrujte se</a></span>
    </div>

    <div id="register" style="display:none">
        <h3>Registrace</h3>
        <form id="register">
            Name: <input type="text" name="name" class="w3-input"> <br> Email: <input type="text" name="email" class="w3-input">
            <br> Heslo: <input type="password" name="password" class="w3-input"> <br>
            <input type="button" value="Register" id="register" class="w3-input">
        </form>
    </div>

    <div id="addCar" style="display:none">
        <h3>Přidat auto</h3>
        <form id="addCar">
            <label for="SPZ">SPZ: </label><input type="text" name="SPZ" class="w3-input"> <br>
            <label for="VIN">VIN: </label><input type="text" name="VIN" class="w3-input"> <br>
            <label for="model">Model: </label><input type="text" name="model" class="w3-input"> <br>
            <label for="year">Rok: </label><input type="text" name="year" class="w3-input"> <br>
            <input type="button" value="Add" id="addCar" class="w3-input">
        </form>
    </div>

    <div id="editCar" style="display:none">
        <h3>Upravit auto</h3>
        <form id="editCar">
            <label for="SPZ">SPZ: </label><input type="text" name="SPZ" class="w3-input"> <br>
            <label for="VIN">VIN: </label><input type="text" name="VIN" class="w3-input"> <br>
            <label for="model">Model: </label><input type="text" name="model" class="w3-input"> <br>
            <label for="year">Rok: </label><input type="text" name="year" class="w3-input"> <br>
            <input type="button" value="Edit" id="editCar" class="w3-input">
        </form>
    </div>

</body>

</html>